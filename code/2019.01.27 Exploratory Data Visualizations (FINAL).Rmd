---
title: "Exploratory Data Visualizations - Divvy Bike Usage Around Chicago"
author: "Markisha (Misha) Berrien"
date: "1/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(geosphere)
library(ggrepel)
```


```{r eval=FALSE, include=FALSE}
#DATASETS
divvy_trips <- read.csv("/Users/Misha/Documents/coding-projects/chicago-bikeshare-analysis/data/cta_l_ridership_dailytots.csv")
bus_cta <- read.csv("/Users/Misha/Documents/coding-projects/chicago-bikeshare-analysis/data/cta_bus_ridership_dailytots.csv")
subway_cta <- read.csv("/Users/Misha/Documents/coding-projects/chicago-bikeshare-analysis/data/Divvy_Trips.csv")

saveRDS(subway_cta, file="subway_cta.Rda")
saveRDS(divvy_trips, file="divvy_trips.Rda")
saveRDS(bus_cta, file="bus_cta.Rda")
```


```{r include=FALSE}
# Datasets
divvy <- readRDS("subway_cta.Rda")
chi_commun_areas <- read_csv("/Users/Misha/Documents/coding-projects/chicago-bikeshare-analysis/data/chi_community_areas.csv")
divvy_stations <- read_csv("/Users/Misha/Documents/coding-projects/chicago-bikeshare-analysis/data/Divvy_Bicycle_Stations_In_Service.csv")

# https://datahub.cmap.illinois.gov/dataset/2010-census-data-summarized-to-chicago-community-areas
census <- read_csv("/Users/Misha/Documents/coding-projects/chicago-bikeshare-analysis/data/chi_pop_ca.csv")
divvy_sample <- sample_frac(divvy, size = .05)

# Add Community Area to dataset
divvy_census <-
  divvy_sample %>%
  left_join(chi_commun_areas, by = "Community.Areas")

divvy_census <- 
  divvy_census %>%
  left_join(census, by = "Community.Areas")
```

On average, the South Side accounts for some of the shortest divvy bike trips in the city, while the West Side and Far Southeast Side account for some of the longest. 
```{r}
# Source: https://stackoverflow.com/questions/34213765/using-the-geosphere-distm-function-on-a-data-table-to-calculate-distances
#parse date columns
divvy_date <- 
  divvy_census %>%
  mutate(dateatime = START.TIME) %>%
  separate(dateatime, into = c("date", "time", "ampm"), sep = " ") %>%
  separate(date, into = c("month", "day", "year", sep = " "))

divvy_distance <- 
  divvy_date %>%
  filter(!is.na(Community.Areas)) %>%
  mutate(distance_hav = distHaversine(matrix(c(FROM.LONGITUDE, FROM.LATITUDE), ncol = 2),
                                   matrix(c(TO.LONGITUDE, TO.LATITUDE), ncol = 2)))

divvy_distance %>%
  filter(!is.na(distance_hav)) %>%
  filter(year == 2018) %>%
  group_by(Chicago.side, Community.Areas) %>%
  summarise(avg_trip_distance = mean(distance_hav)) %>%
  ggplot(aes(x = reorder(Chicago.side, avg_trip_distance), y = avg_trip_distance, fill = Chicago.side)) +
  geom_boxplot() +
  theme(legend.position = "none") +
  labs(title = "On Average the South Side accounts for the shortest divvy trips \nwithin the City of Chicago",
    subtitle = "Average distance traveled per divvy trip in 2018",
    caption = "Chicago Data Portal Divvy Trip Data",
    x = "Chicago 'Sides'",
    y = "Average Divvy Trip Distance (Meters)") +
  coord_flip()

```

Although the South Side accounts for some of the shortest bike trips in terms of distance, this area accounts for some of the longest trip duration in minutes. A divvy membership includes 30 minutes of "free riding time" from bike check-out to return. In the majority of the Chicago areas, the average ride duration hovers just around the 30-minute mark, but the South, Southwest and West Side do not follow this trend. 
```{r}
divvy_census %>%
  filter(!is.na(Community.Areas)) %>%
  group_by(Chicago.side, Community.Areas) %>%
  summarise(average_time = mean(TRIP.DURATION)/60) %>%
  ggplot(aes(x = reorder(Chicago.side, average_time), y = average_time, fill = Chicago.side)) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(
    title = "Divvy bike trip lengths are over two times higher \nin South, Southwest and West Chicago",
    subtitle = "Average divvy bike trip length from 2013 - 2018",
    caption = "Chicago Data Portal Divvy Trip Data",
    x = "Chicago 'Sides",
    y = "Average Trip Time (In Minutes)") +
  theme(legend.position = "none")
```

Upon closer inspection of the three "Chicago Sides" with higher than average rider time, you can see five Community areas that are responsible for increasing the average trip duration time for the South, Southwest and West side. 
```{r}
divvy_census %>%
  filter(!is.na(Community.Areas)) %>%
  filter(Chicago.side == c("South Side", "Southwest side", "West Side")) %>%
  group_by(Community.Area.Name, Chicago.side) %>%
  summarise(average_time = mean(TRIP.DURATION)/60) %>%
  ggplot(aes(x = reorder(Community.Area.Name, average_time), y = average_time, 
             fill = as.factor(Chicago.side))) +
  geom_col() +
  coord_flip() +
    labs(title = "Five community areas in South, Southwest and \nWest Chicago account for above average trip time",
    subtitle = "Average divvy bike trip length from 2013 - 2018 in South, \nSouthwest and West Side Chicago",
    caption = "Chicago Data Portal Divvy Trip Data",
    x = "Chicago Community Areas",
    y = "Average Trip Time (In Minutes)") +
  labs(fill = "Chicago 'Sides'")

```

This graph compares divvy ride time duration changes between 2014 and 2017. This shows a strong linkage between number of bike stations in an area and trip duration. All areas show a clear decline in the average trip duration as the number of stations increase. 
```{r}
divvy_stations_year <- 
  divvy_date %>%
  filter(!is.na(Community.Areas)) %>%
  group_by(Chicago.side, year) %>%
  distinct(FROM.STATION.ID) %>%
  summarise(n_stations = n()) 

divvy_date %>%
  filter(!is.na(Community.Areas)) %>%
  filter(year == c(2014, 2017)) %>%
  group_by(Chicago.side, year) %>%
  summarise(average_trip_time = mean(TRIP.DURATION)) %>%
  left_join(divvy_stations_year, by = c("Chicago.side", "year")) %>%
  arrange(Chicago.side, year) %>%
  ggplot(aes(x = year, y = average_trip_time, group = Chicago.side, 
             size = n_stations, 
             color = as.factor(Chicago.side))) +
  geom_point(alpha = 0.6) +
  geom_line(size = 1) +
  labs(
    title="Average ride time reduces as number of stations increase",
    subtitle="DC CAS Math & Reading Scores (2014) ",
    caption="Chicago Data Portal Divvy Trip Data",
    x="Year",
    y="Divvy Trip Time (In Seconds)",
    color = "Chicago 'Side'",
    size = "Number of Stations")

```

Share of the city's population does not directly correlate with share of the city's divvy ridership. for example, The South Side makes up less than 10% of the city's population, but accounts for over 40% of the rides in 2018. 
```{r}
div_area <- 
  divvy_date %>%
  filter(!is.na(Community.Areas)) %>%
  filter(year == 2018) %>%
  group_by(Community.Areas) %>%
  summarise(pop = unique(Total.Population), 
            n_rides = n()) %>%
  left_join(chi_commun_areas, by = "Community.Areas") %>%
  group_by(Chicago.side) %>%
  summarise(sum_pop = sum(pop),
            sum_rides = sum(n_rides),
            perc_rides = sum_rides/17424736, 
            perc_pop = sum_pop/2695598)

div_area %>%
  ggplot(aes(x = perc_pop, y = perc_rides, color = Chicago.side)) +
  geom_point(size = 1) +
  theme(legend.position = "none") +
  geom_label_repel(aes(label=Chicago.side)) +
  labs(
    title="The South Side sccounts for less than 10% of the \npopulation, but accounts for over 40% of rides",
    subtitle="Divvy Ridership in 2014",
    caption="Chicago Data Portal Divvy Trip Data",
    x="Chicago Population (by percentage)",
    y="Divvy Bike Rideshare (by percentage)")
      

```
1
