---
title: "Chicago Bikeshare Analysis - Divvy Bike Usage in Chicago's Transit Deserts"
author: "Markisha (Misha) Berrien"
date: "2/10/2019"
output:
  html_document:
    code_folding: hide
---


```{r include=FALSE}
# Set-up Environment 
#knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(geosphere)
library(ggrepel)
library(forcats)
library(devtools)
library(extrafont)
library(ggmap)
library(lubridate)
library(sf)
#library(plotKML)
# devtools::install_github('cttobin/ggthemr') # This sets a theme for the entire session

#register_google(key = "AIzaSyDu8dhum7j58jpfpQq6aE2jcZLgku9wzzI")

```


```{r global_options, include=FALSE}
# Set height and width of figures in RMarkdown
knitr::opts_chunk$set(fig.width=10, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE)
```


```{r eval=FALSE, include=FALSE}
# Read-in and Save Large Data Sets
divvy_trips <- 
  read.csv("Divvy_Trips.csv")

saveRDS(divvy_trips, file = "divvy_trips.Rda")
```


```{r warning=FALSE, message=FALSE, error=FALSE, include=FALSE}
# Read in datasets
# Chicago Census Information 
census_2010 <- 
  read_csv("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/chi_pop_ca.csv")

# Read in Saved Divvy dataset and update
divvy <- 
  readRDS("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/divvy_trips.Rda") %>%
  mutate(STOP.TIME = mdy_hms(STOP.TIME), 
         START.TIME = mdy_hms(START.TIME)) %>%
  arrange(START.TIME)
# Take 5% Sample of divvy dataset
divvy_sample <- 
  sample_frac(divvy, size = .05)

# Chicago Community Areas and Chicago Sides
chi_ca <- 
  read_csv("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/chi_community_areas.csv")

# Divvy statio location 
divvy_stations <- 
  read_csv("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/Divvy_Bicycle_Stations_In_Service.csv")
# Add Community Area and population to divvy dataset
divvy_census <-
  divvy_sample %>%
  left_join(chi_ca, by = "Community.Areas")

divvy_comp <- 
  divvy_census %>%
  filter(!is.na(Community.Areas)) %>%
  left_join(census_2010, by = "Community.Areas") %>%
  select(-X4, -X5) %>%
  mutate(distance_meters = 
           distHaversine(matrix(
             c(FROM.LONGITUDE, FROM.LATITUDE), ncol = 2),
                                   matrix(
                                     c(TO.LONGITUDE, TO.LATITUDE), ncol = 2)))
```


## Color Palette & Styling 
```{r warning=FALSE, message=FALSE, error=FALSE}
# Create color palette
# Source: https://drsimonj.svbtle.com/creating-corporate-colour-palettes-for-ggplot2

# Chosen Colors
colors_all <- c(
  light_blue   = "#a6cee3",
  dark_blue    = "#1f78b4",
  light_green  = "#b2df8a",
  dark_green   = "#33a02c",
  light_red    = "#fb9a99", 
  dark_red     = "#e31a1c",
  light_orange = "#fdbf6f",
  dark_orange  = "#ff7f00",
  dark_purple = "#9290db")

# Color function (makes it possible to call colors by name)
bikeshare_colors<- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (colors_all)
  colors_all[cols]
}

# Create Pallette
bikeshare_palettes <- list(
  main = bikeshare_colors("light_blue", "dark_blue", "light_green", "dark_green", 
                        "light_red", "dark_red", "light_orange", "dark_orange", "dark_purple"),  
  dark = bikeshare_colors("dark_blue", "dark_green", "dark_red", "dark_orange", "dark_purple"),
  light = bikeshare_colors("light_blue", "light_green", "light_red", "light_orange", "dark_purple"),
  blue_scale = bikeshare_colors("dark_blue", "light_blue"), 
  green_scale = bikeshare_colors("dark_green", "light_green"), 
  red_scale = bikeshare_colors("dark_red", "light_red"), 
  orange_scale = bikeshare_colors("dark_orange", "light_orange"), 
  two_variables = bikeshare_colors("dark_blue", "dark_orange")
  )

# Create Pallette function 
bikeshare_pal <- function(palette = "main", reverse = FALSE, ...) {
  pal <- bikeshare_palettes[[palette]]

  if (reverse) pal <- rev(pal)

  colorRampPalette(pal, ...)
}

scale_color_bikeshare <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- bikeshare_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("colour", paste0("bikeshare_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

scale_fill_bikeshare <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- bikeshare_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("bikeshare_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Continuous usage example
# bikeshare_pal("dark")(10)

# print main color palette
#display.pal(colors_all, sel=1:length(colors_all), names=FALSE)

# Create Theme 
bikeshare_style <- function() {
  theme(
    axis.line = element_line(size = 0.05),
    text = element_text(family = "SourceSerifPro-Regular", face = "bold", 
                              colour = "black", size = 11, 
                              hjust = 0.5, vjust = 1, angle = 0, 
                              lineheight = 0.9), 
    plot.subtitle = element_text(family = "SourceSerifPro-Regular",
                               size = 9), 
    legend.background = element_rect(fill = "white", color = "black", size = 0.1),
    
    axis.text = element_text(family="SourceSerifPro-Regular",
                           size=9,
                           color="#222222",
                           face = "bold"),
    axis.text.x = element_text(vjust = 1), 
    axis.ticks = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "black", size = 0.1),
    panel.background = element_rect(fill = "white", colour = NA),
    
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(size  = 22,  hjust = 0),
    plot.background = element_rect(colour = "white", fill = "white", size = 1),
    plot.margin = unit(c(2, 2, 1, 1), "lines")
  )
  }
```

## Map 1: Map of Chicago with Population Density & Transit Deserts (colors are Chicago side)
```{r warning=FALSE, message=FALSE, error=FALSE}
# Chicago Map by Community Areas
chicago_map <- 
  st_read("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/boundaries-communityareas/geo_export_07d5c241-72fe-46c1-bb00-a282acf7a63c.shp")
# Simple map of divvy bike station locations throughout the city of chicago + Colored by Chicago side 
ggplot() +
  geom_sf(data = chicago_map, col="white") +
  geom_point(data = divvy_stations, aes(Longitude, Latitude), size = 0.2) +
#  scale_fill_viridis_c(name = bikeshare_colors) +
  ggtitle("Divvy Bike Station Locations")
```

## Map 2: Map of Divvy Bike Station Locations by year 
```{r warning=FALSE, message=FALSE, error=FALSE}
# Makes list of first bike check-out of each station. This gives opening date of each station
# Source: https://stackoverflow.com/questions/19944334/extract-rows-for-the-first-occurrence-of-a-variable-in-a-data-frame
station_dates <- 
  divvy[match(unique(divvy$TO.STATION.ID), divvy$TO.STATION.ID),] %>%
  select(TO.STATION.ID, STOP.TIME) %>%
  arrange(STOP.TIME) %>%
  mutate(year = year(STOP.TIME), 
         month = month(STOP.TIME), 
         day = day(STOP.TIME), 
         OPENING.DATE = as.Date(paste(year, month, day, sep='-'))) %>%
#  rename("STATION.ID" = "TO.STATION.ID") %>%
  select(TO.STATION.ID, OPENING.DATE)

# Join opening date information to divvy_station dataframe
divvy_opening <- 
  divvy_stations %>%
  left_join(station_dates, by = c("ID" = "TO.STATION.ID")) %>%
  mutate(OPENING.YEAR = year(OPENING.DATE)) %>%
  filter(!is.na(OPENING.YEAR))

# End Map 
ggplot() +
  geom_sf(data = chicago_map, fill = "grey", col = "white") +
  geom_point(data = divvy_opening, aes(Longitude, Latitude, color = factor(OPENING.YEAR)), size = 0.3) +
  scale_color_bikeshare(palette = "light") +
  ggtitle("Divvy Bike Station Opening by Year")
```

## Plot 1: Seasonal bike usage fluxuations 
```{r warning=FALSE, message=FALSE, error=FALSE}
#Number of bikes used per day from Summer 2016 to Summer 2017
# Source: https://medium.com/optima-blog/using-polar-coordinates-for-better-visualization-1d337b6c9dec
divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  filter(year(START.TIME) == c(2016, 2017)) %>%
  mutate(year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME), 
         date = as.Date(paste(year, month, day, sep='-')), 
         YEAR.MONTH = factor(paste(year, month, sep='-')), 
         Summer = ifelse(date >= "2016-06-20" & date <= "2016-09-21" | 
                           date == "2017-06-20", 1, 0), 
         # Add season column
         Fall = ifelse(date >= "2016-09-21" & date <= "2016-12-20", 1, 0), 
         Winter = ifelse(date >= "2016-12-21" & date <= "2017-03-19", 1, 0), 
         Spring = ifelse(date >= "2017-03-20" & date <= "2017-06-19", 1, 0)) %>%
  gather(key = season, value = value, c(Summer, Fall, Winter, Spring)) %>% 
  filter(value >= 1) %>%
  mutate(YEAR.MONTH = factor(YEAR.MONTH, 
                             levels = c("2016-6", "2016-7", "2016-8", 
                                        "2016-9", "2016-10", "2016-11", 
                                        "2016-12", "2017-1", "2017-2", 
                                        "2017-3", "2017-4", "2017-5", "2017-6"))) %>%
  filter(date >= "2016-06-20" & date < "2017-06-20") %>%
  group_by(date, season) %>%
  dplyr::summarise(n_trips = n()) %>%
  ggplot(aes(x = date, y = n_trips, fill = season)) +
  geom_bar(stat = "identity") +
  coord_polar() +
  scale_fill_bikeshare(palette = "dark") +
  theme(
    legend.background = element_rect(fill = "white", color = "black", size = 0.1),
    panel.background = element_rect(fill = "white", colour = NA),
    strip.background = element_rect(fill = "white"),
    plot.background = element_rect(colour = "white", fill = "white", size = 1), 
    panel.grid = element_line(color = "black", size = 0.05)
  )

```

## Plot 2: Usage fluxuation by day broken up by Chicago Sides
The Southwest and West side show inverse patterns during the day. 
```{r warning=FALSE, message=FALSE, error=FALSE}
divvy_comp %>%
  filter(year(START.TIME) == c(2017)) %>%
  filter(!is.na(Community.Areas)) %>%
  mutate(WEEK.DAY = wday(START.TIME, label = TRUE),
         year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME)) %>%
  group_by(year, month, day, Chicago.side, WEEK.DAY, Chicago.side) %>%
  count() %>%
#  rename("TRIP.NUM" = "freq") %>%
  group_by(WEEK.DAY, Chicago.side) %>%
  dplyr::summarise(MEAN.TRIP.NUM = mean(n)) %>%
  ggplot(aes(x = WEEK.DAY, y = MEAN.TRIP.NUM, fill = WEEK.DAY)) +
  geom_col() +
  facet_wrap(~ Chicago.side) +
  coord_flip() +
  scale_fill_bikeshare(palette = "main") +
  bikeshare_style() +
  labs(title = "The South Side maintains high average Divvy bike usage throughout the week",
    subtitle = "Average Divvy bike usage in 2017.",
    caption = "Source: Chicago Data Portal",
    y = "Average Bike Rides per Day") +
  scale_y_continuous(expand=c(0,0)) +
  scale_x_discrete(expand=c(0,0)) +
  theme(legend.position="none", 
        strip.text.x = element_text(size = 10), 
        panel.margin = unit(1, "lines"),
        axis.title.y = element_blank())
```

## Plot 3: Median Divvy Bike ride time per Community Area (above and below global median)
```{r warning=FALSE, message=FALSE, error=FALSE}
# Global median time for trip duration in the city of chicago
# Median trip duration in Chicago is 11.46667	minutes
#divvy_comp %>%
#  filter(!is.na(Community.Areas)) %>%
#  filter(year(START.TIME) == c(2017)) %>%
#  filter(!TRIP.DURATION > 86400) %>% # Filter out bikes classified as stolen (greater than 24 hours)
#  summarise(median_trip_duration = median(TRIP.DURATION)/60)

divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  filter(year(START.TIME) == c(2017)) %>%
  filter(!TRIP.DURATION > 86400) %>% # Filter out bikes classified as stolen (greater than 24 hours)
  group_by(Community.Area.Name, Chicago.side) %>%
  dplyr::summarise(median_time = median(TRIP.DURATION)/60) %>% # average trip by comm area in Minutes
  mutate(de_meaned_time = median_time - 11.46) %>%
  mutate(axis_color = ifelse(de_meaned_time > 0, "red", "blue")) %>%
  ggplot(aes()) +
  geom_segment(aes(x = reorder(as.factor(Community.Area.Name), de_meaned_time), xend = Community.Area.Name, y = 0, yend = de_meaned_time, color = axis_color), size=1.3, alpha=0.9) +
  theme(
    legend.position = "none"
  ) +
  xlab("") +
  coord_flip() +
  bikeshare_style() +
  scale_y_continuous(expand=c(0,0), breaks = c(-4, -2, 0, 2, 4, 6, 8, 10, 12)) +
#  scale_y_continuous(expand=c(0,0)) +
  scale_x_discrete(expand=c(0,0)) +
  labs(title = "Average Divvy bike rental time is 2 - 10 minutes higher than the \ncity average in many suburban areas",
    subtitle = "The average Divvy bike rental time in Chicago is 11.5 minutes. Many community areas in \nthe North and Southern suburbs fall above the mean.",
    caption = "Source: Chicago Data Portal",
    x = "Chicago Community Areas", 
    y = "Minutes above and below Chicago's Average Divvy Rental Time", 
    fill = "Divvy Plan Types")
```

## Plot 4: Divvy Bike Customer type by Chicago Side (proportions)
```{r warning=FALSE, message=FALSE, error=FALSE}
#table(divvy_comp$USER.TYPE, divvy_comp$Chicago.side)

divvy_comp$USER.TYPE <- fct_recode(divvy_comp$USER.TYPE, "Customer" = "Single Riders", "Subscriber" = "Annual Member", "Dependent" = "24Hrs Unlimited Rides")

divvy_comp %>%
  filter(!USER.TYPE == "Dependent") %>%
  group_by(USER.TYPE) %>%
  ggplot(aes(x = Chicago.side, fill = USER.TYPE)) +
  geom_bar(position = "fill") +
  coord_flip() +
  ylab("proportion") +
  bikeshare_style() +
  labs(title = "Divvy Bike Single-ride usage rate is highest on the South Side",
    subtitle = "Divvy bike customers can choose between three different plans: Single Ride, Explorer Pass and \nAnnual Membership.The proportion of Explorer Pass customers is neglibible and has been omitted.",
    caption = "Source: Chicago Data Portal",
    y = "Customer Type Proportions by Chicago Side", 
    fill = "Divvy Plan Types") +
  scale_y_continuous(expand=c(0,0)) +
  scale_x_discrete(expand=c(0,0)) +
  scale_fill_bikeshare(palette = "two_variables") +
  theme(axis.title.y = element_blank())
```

## Plot 5: Proportion of population vs. proportion of trips originating in the area
```{r warning=FALSE, message=FALSE, error=FALSE}
#Proportion of rides per chicago side
divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  filter(year(START.TIME) == c(2017)) %>%
  group_by(Community.Areas) %>%
  dplyr::summarise(pop = unique(Total.Population), 
            n_rides = n()) %>%
  left_join(chi_ca, by = "Community.Areas") %>%
  group_by(Chicago.side) %>%
  dplyr::summarise(sum_pop = sum(pop), 
            sum_rides = sum(n_rides)) %>%
  gather(key = object, value = value, c(sum_pop, sum_rides)) %>%
  ggplot(aes(x = object, y = value, fill = Chicago.side)) +
  geom_col(position = "fill") +
  ggtitle("Proportion of population vs. proportion of trips originating in the area") +
  scale_fill_bikeshare() +
  bikeshare_style() +
  labs(title = "Percentage of Divvy bike trips that originate on the South Side far outstrips \nthe areas percentage of Chicago's population",
    subtitle = "2017 Divvy Ridership Data",
 #   y = "Customer Type Proportions by Chicago Side", 
    fill = "Chicago Sides'") +
  scale_y_continuous(expand=c(0,0), labels=c("0.00" = "0", "0.25" = "25", 
                                             "0.50" = "50", "0.75" = "75", "1.00" = "100")) +
  scale_x_discrete(expand=c(0,0), labels=c("sum_pop" = "% of population by Chicago Side", "sum_rides" = "% of Divvy bike rides by Chicago Side")) +
  scale_fill_bikeshare(palette = "main") +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.title.y=element_blank())
```

## Plot 6.1: Average distance of divvy trip by Chicago Side 

FIX THIS LAST! 
```{r warning=FALSE, message=FALSE, error=FALSE}
divvy_comp %>%
  filter(!is.na(distance_meters)) %>%
  mutate(year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME), 
         date = as.Date(paste(year, month, day, sep='-')), 
         YEAR.MONTH = factor(paste(year, month, sep='-'))) %>%
  filter(year == 2018) %>%
  group_by(Chicago.side) %>%
  dplyr::summarise(avg_distance_meters = mean(distance_meters)) %>%
  ggplot(aes(x = reorder(Chicago.side, avg_distance_meters), y = avg_distance_meters, 
             fill = Chicago.side), fill = "#2c7bb6") +
  geom_point() +
  theme(legend.position = "none") +
  labs(title = "The South Side accounts for the shortest average Divvy \ntrips within the City of Chicago",
    subtitle = "Average distance traveled by divvy trips in 2018",
    caption = "Chicago Data Portal Divvy Trip Data",
    x = "Chicago 'Sides'",
    y = "Average Divvy Trip Distance (Meters)") +
  coord_flip() +
   bikeshare_style()
```

## Plot 6.2: Distance density plot by Chicago side
```{r}
divvy_comp %>%
  filter(Chicago.side %in% c("South Side", "Far North side")) %>%
  ggplot(aes(x = log(distance_meters), fill = Chicago.side)) +
  geom_density(alpha = 0.3)
```

## Plot 7: Average Ride time reducas as number of station increases

This graph compares divvy ride time duration changes between 2014 and 2017. This shows a strong linkage between number of bike stations in an area and trip duration. All areas show a clear decline in the average trip duration as the number of stations increase. 
```{r warning=FALSE, message=FALSE, error=FALSE}
divvy_stations_year <- 
  divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  mutate(year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME), 
         date = as.Date(paste(year, month, day, sep='-')), 
         YEAR.MONTH = factor(paste(year, month, sep='-'))) %>%
  group_by(Chicago.side, year) %>%
  distinct(FROM.STATION.ID) %>%
  summarise(n_stations = n()) 

divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  mutate(year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME), 
         date = as.Date(paste(year, month, day, sep='-')), 
         YEAR.MONTH = factor(paste(year, month, sep='-'))) %>%
  filter(year == c(2014, 2017)) %>%
  group_by(Chicago.side, year) %>%
  summarise(average_trip_time = mean(TRIP.DURATION)) %>%
  left_join(divvy_stations_year, by = c("Chicago.side", "year")) %>%
  arrange(Chicago.side, year) %>%
  ggplot(aes(x = year, y = average_trip_time, group = Chicago.side, 
             size = n_stations, 
             color = as.factor(Chicago.side))) +
  geom_point(alpha = 0.6) +
  geom_line(size = 1) +
  labs(title = "Average ride time reduces as number of stations increase",
    subtitle = "Average trip time comparios across all eight 'Chicago Sides' in 2014 and 2017",
    caption="Chicago Data Portal Divvy Trip Data",
    x="Year",
    y="Divvy Trip Time (In Seconds)",
    color = "Chicago 'Side'",
    size = "Number of Stations") +
  bikeshare_style()

```

