---
title: "Chicago Bikeshare Analysis - Divvy Bike Usage in Chicago's Transit Deserts"
author: "Markisha (Misha) Berrien"
date: "2/10/2019"
output:
  html_document:
    code_folding: hide
---

1) Where are all these rides on the south-side originating? (which community area?). Zoom in on south side
2) cost per ride
3) something with gender divide 
4) What happens with older station ridership when new stations open up nearby (use size and color to show change)
5) bus routs for l trains and buses. There is a n ST function for width around lines. Make a map around the that is not a distance around a certain point. (every bus top has a point). ST_buffer (look this up). could fill in the buffer area with colors. If I could get the l lines and shape. Could show that these are the areas within walking distance of an l station .

- show this data overtime an


```{r include=FALSE}
# Set-up Environment 
#knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(geosphere)
library(ggrepel)
library(forcats)
library(devtools)
library(extrafont)
library(ggmap)
library(lubridate)
library(sf)
library(directlabels)
library(forcats)
#library(plotKML)
# devtools::install_github('cttobin/ggthemr') # This sets a theme for the entire session

#register_google(key = "AIzaSyDu8dhum7j58jpfpQq6aE2jcZLgku9wzzI")

```


```{r eval=FALSE, include=FALSE}
# Read-in and Save Large Data Sets
divvy_trips <- 
  read.csv("Divvy_Trips.csv")

saveRDS(divvy_trips, file = "divvy_trips.Rda")
```


```{r warning=FALSE, message=FALSE, error=FALSE, include=FALSE}
# Read in datasets
# Chicago Census Information 
census_2010 <- 
  read_csv("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/chi_pop_ca.csv")

# Read in Saved Divvy dataset and update
divvy <- 
  readRDS("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/divvy_trips.Rda") %>%
  mutate(STOP.TIME = mdy_hms(STOP.TIME), 
         START.TIME = mdy_hms(START.TIME)) %>%
  arrange(START.TIME)

# Take 5% Sample of divvy dataset
divvy_sample <- 
  sample_frac(divvy, size = .05)

# Chicago Community Areas and Chicago Sides
chi_ca <- 
  read_csv("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/chi_community_areas.csv")

# Divvy station location 
divvy_stations <- 
  read_csv("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/Divvy_Bicycle_Stations_In_Service.csv")

# Chicago Map by Community Areas
chicago_map <- 
  st_read("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/boundaries-communityareas/geo_export_07d5c241-72fe-46c1-bb00-a282acf7a63c.shp")
```

```{r eval=FALSE, include=FALSE}
# Add Community Area and population to divvy dataset
divvy_census <-
#  divvy_sample %>%
  divvy %>%
  left_join(chi_ca, by = "Community.Areas")

divvy_comp <- 
  divvy_census %>%
  filter(!is.na(Community.Areas)) %>%
  left_join(census_2010, by = "Community.Areas") %>%
  select(-X4, -X5) %>%
  mutate(distance_meters = 
           distHaversine(matrix(
             c(FROM.LONGITUDE, FROM.LATITUDE), ncol = 2),
                                   matrix(
                                     c(TO.LONGITUDE, TO.LATITUDE), ncol = 2)))

# Save File
saveRDS(divvy_comp, file = "divvy_comp.Rda")
```


```{r warning=FALSE, message=FALSE, error=FALSE, include=FALSE}
divvy_c <- 
  readRDS("/Users/Misha/Documents/04-coding-projects/chicago-bikeshare-analysis/code-data/divvy_comp.Rda")
```



```{r}
divvy_comp %>%
  group_by(FROM.STATION.ID) %>%
  summarise(open_date = min(START.TIME)) %>%
  arrange(open_date) %>%


```


```{r warning=FALSE, message=FALSE, error=FALSE, include=FALSE}
# Create color palette
# Source: https://drsimonj.svbtle.com/creating-corporate-colour-palettes-for-ggplot2

# Chosen Colors
colors_all <- c(
  light_blue   = "#a6cee3",
  dark_blue    = "#1f78b4",
  light_green  = "#b2df8a",
  dark_green   = "#33a02c",
  light_red    = "#fb9a99", 
  dark_red     = "#e31a1c",
  light_orange = "#fdbf6f",
  dark_orange  = "#ff7f00",
  dark_purple  = "#9290db", 
  orange_blue1 = "#e8e532", 
  orange_blue2 = "#eab931", 
  orange_blue3 = "#df903b", 
  orange_blue4 = "#c46e53", 
  orange_blue5 = "#036eb0")

#e8e532 #eab931 #df903b #c46e53 #036eb0

# Color function (makes it possible to call colors by name)
bikeshare_colors<- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (colors_all)
  colors_all[cols]
}

# Create Pallette
bikeshare_palettes <- list(
  main = bikeshare_colors("light_blue", "dark_blue", "light_green", "dark_green", 
                        "light_red", "dark_red", "light_orange", "dark_orange", "dark_purple"),  
  dark = bikeshare_colors("dark_blue", "dark_green", "dark_red", "dark_orange", "dark_purple"),
  light = bikeshare_colors("light_blue", "light_green", "light_red", "light_orange", "dark_purple"),
  blue_scale = bikeshare_colors("dark_blue", "light_blue"), 
  green_scale = bikeshare_colors("dark_green", "light_green"), 
  red_scale = bikeshare_colors("dark_red", "light_red"), 
  orange_scale = bikeshare_colors("dark_orange", "light_orange"), 
  two_variables = bikeshare_colors("dark_blue", "dark_orange"), 
  map_step = bikeshare_colors( "orange_blue1", "orange_blue2", 
                               "orange_blue3", "orange_blue4", "orange_blue5")
  )

# Create Pallette function 
bikeshare_pal <- function(palette = "main", reverse = FALSE, ...) {
  pal <- bikeshare_palettes[[palette]]

  if (reverse) pal <- rev(pal)

  colorRampPalette(pal, ...)
}

# Color scale Fill 
scale_color_bikeshare <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- bikeshare_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("colour", paste0("bikeshare_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Fill scale fill 
scale_fill_bikeshare <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- bikeshare_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("bikeshare_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Continuous usage example
# bikeshare_pal("dark")(10)

# print main color palette
#display.pal(colors_all, sel=1:length(colors_all), names=FALSE)

# Create Theme 
bikeshare_style <- function() {
  theme(
    axis.line = element_line(size = 0.05),
    text = element_text(family = "SourceSerifPro-Regular", face = "bold", 
                              colour = "black", size = 11, 
                              hjust = 0.5, vjust = 1, angle = 0, 
                              lineheight = 0.9), 
    plot.subtitle = element_text(family = "SourceSerifPro-Regular",
                               size = 9), 
    legend.background = element_rect(fill = "white", color = "black", size = 0.1),
    
    axis.text = element_text(family="SourceSerifPro-Regular",
                           size=9,
                           color="#222222",
                           face = "bold"),
    axis.text.x = element_text(vjust = 1), 
    axis.ticks = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "black", size = 0.1),
    panel.background = element_rect(fill = "white", colour = NA),
    
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(size  = 22,  hjust = 0),
    plot.background = element_rect(colour = "white", fill = "white", size = 1),
    plot.margin = unit(c(2, 2, 1, 1), "lines")
  )
}


theme_clean_map <- function(base_size = 12) {
  require(grid)
  theme_grey(base_size) %+replace%
    theme(
      axis.title      =   element_blank(),
      axis.text       =   element_blank(),
      axis.ticks       =   element_blank(),
      panel.background    =   element_blank(),
      panel.grid      =   element_blank(),
      panel.grid.major =  element_line(size = 0),
      panel.grid.minor = element_blank(),
      panel.spacing    =   unit(0,"lines"),
      plot.margin     =   unit(c(0,0,0,0),"lines"),
      complete = TRUE
    )
}
```

###Map 1: Map of Chicago Community Areas Colored by Chicago Sides'
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=9, fig.width=6}
# Merge census and community area data  
census_update <- full_join(census_2010, chi_ca, by = "Community.Areas") %>%
  select(-X4, -X5)
census_update$Community.Areas <- factor(census_update$Community.Areas)

# Merge census and chicago map data 
map_merged <- left_join(chicago_map, census_update, by = c("area_num_1" = "Community.Areas"))

# Simple map of divvy bike station locations throughout the city of chicago + Colored by Chicago side 
ggplot() +
  geom_sf(data = map_merged, aes(fill = Chicago.side), col="white") +
#  scale_fill_viridis_c(name = bikeshare_colors) +
  theme(axis.title.y = element_blank(), 
    axis.title.x = element_blank(), 
    axis.text.x = element_blank(),
    axis.text.y = element_blank(), 
    axis.ticks = element_blank(),
    text = element_text(family = "SourceSerifPro-Regular", face = "bold", 
                              colour = "black", size = 11, 
                              hjust = 0.5, vjust = 1, angle = 0, 
                              lineheight = 0.9), 
#    legend.position = "none", 
    rect = element_blank()) + # Remove map gridlines
#  labs(fill = "Chicago Sides'"
#   title = "Community Areas Grouped by Chicago Side'",
#    subtitle = "From 2013 to 2018",
#    caption = "Source: Chicago Data Portal") +
  scale_fill_bikeshare(palette = "main") +
  guides(colour = guide_legend(override.aes = list(size=3)))
```


```{r}
station_total_year <- 
  divvy_c[match(unique(divvy_c$TO.STATION.ID), divvy_c$TO.STATION.ID),] %>%
  select(TO.STATION.ID, STOP.TIME, Chicago.side) %>%
  arrange(STOP.TIME) %>%
  mutate(year = year(STOP.TIME), 
         month = month(STOP.TIME), 
         day = day(STOP.TIME), 
         OPENING.DATE = as.Date(paste(year, month, day, sep='-'))) %>%
  select(year, TO.STATION.ID, Chicago.side) %>%
  group_by(year, Chicago.side) %>%
  summarise(station_openings = n())

station_total_year

```


###Map 2: Map of Divvy Bike station locations colored by opening year
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=7, fig.width=6}
# Makes list of first bike check-out of each station. This gives opening date of each station
# Source: https://stackoverflow.com/questions/19944334/extract-rows-for-the-first-occurrence-of-a-variable-in-a-data-frame

station_dates <- 
  divvy[match(unique(divvy$TO.STATION.ID), divvy$TO.STATION.ID),] %>%
  select(TO.STATION.ID, STOP.TIME)

station_dates <-
  station_dates %>%
  arrange(STOP.TIME) %>%
  mutate(year = year(STOP.TIME), 
         month = month(STOP.TIME), 
         day = day(STOP.TIME), 
         OPENING.DATE = as.Date(paste(year, month, day, sep='-'))) %>%
#  rename("STATION.ID" = "TO.STATION.ID") %>%
  select(TO.STATION.ID, OPENING.DATE)

# Join opening date information to divvy_station dataframe
divvy_opening <- 
  divvy_stations %>%
  left_join(station_dates, by = c("ID" = "TO.STATION.ID")) %>%
  mutate(OPENING.YEAR = year(OPENING.DATE)) %>%
  filter(!is.na(OPENING.YEAR))

# Filter Evanston Points
divvy_opening_sub <- 
  divvy_opening %>%
  filter(!Latitude >= 42.02346)

# End Map 
ggplot() +
  geom_sf(data = chicago_map, fill = "#CCCCCC", col = "white") +
  geom_point(data = divvy_opening_sub, aes(Longitude, Latitude, color = factor(OPENING.YEAR)), size = 0.3) +
#  ggtitle("Divvy Bike Station Opening by Year") +
#  bikeshare_style() + 
  theme(axis.title.y = element_blank(), 
    axis.title.x = element_blank(), 
    axis.text.x = element_blank(),
    axis.text.y = element_blank(), 
    axis.ticks = element_blank(),
    text = element_text(family = "SourceSerifPro-Regular", face = "bold", 
                              colour = "black", size = 11, 
                              hjust = 0.5, vjust = 1, angle = 0, 
                              lineheight = 0.9), 
    rect = element_blank()) + # Remove map gridlines
  labs(color = "Years", 
    title = "Divvy bike stations opened first in West, Southwest and South Chicago \nand later expanded to Chicago's Northern and Southern regions",
    subtitle = "By the end of 2013, Divvy opened 300 stations scattered along Chicago's Far North, \nNorth, Central, West, Southwest and South sides.",
    caption = "Source: Chicago Data Portal"
    ) +
  scale_color_bikeshare(palette = "map_step") +
  guides(colour = guide_legend(override.aes = list(size=6)))

# legend.position = c(0.9, 0.7),
```

###Plot 1: Divvy bike usage fluxuations by season
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=9, fig.width=6}
#Number of bikes used per day from Summer 2016 to Summer 2017
# Source: https://medium.com/optima-blog/using-polar-coordinates-for-better-visualization-1d337b6c9dec
divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  filter(year(START.TIME) == c(2016, 2017)) %>%
  mutate(year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME), 
         date = as.Date(paste(year, month, day, sep='-')), 
         YEAR.MONTH = factor(paste(year, month, sep='-')), 
         Summer = ifelse(date >= "2016-06-20" & date <= "2016-09-21" | 
                           date == "2017-06-20", 1, 0), 
         # Add season column
         Fall = ifelse(date >= "2016-09-21" & date <= "2016-12-20", 1, 0), 
         Winter = ifelse(date >= "2016-12-21" & date <= "2017-03-19", 1, 0), 
         Spring = ifelse(date >= "2017-03-20" & date <= "2017-06-19", 1, 0)) %>%
  gather(key = season, value = value, c(Summer, Fall, Winter, Spring)) %>% 
  filter(value >= 1) %>%
  mutate(YEAR.MONTH = factor(YEAR.MONTH, 
                             levels = c("2016-6", "2016-7", "2016-8", 
                                        "2016-9", "2016-10", "2016-11", 
                                        "2016-12", "2017-1", "2017-2", 
                                        "2017-3", "2017-4", "2017-5", "2017-6"))) %>%
  filter(date >= "2016-06-20" & date < "2017-06-20") %>%
  group_by(date, season) %>%
  dplyr::summarise(n_trips = n()) %>%
  ggplot(aes(x = date, y = n_trips, fill = season)) +
  geom_bar(stat = "identity") +
  coord_polar(start = 6.1) +
#  scale_fill_discrete(breaks = c(Summer, Fall, Winter, Spring)) +
  scale_fill_bikeshare(palette = "dark") +
  theme(legend.background = element_rect(fill = "white", color = "black", size = 0.1),
    panel.background = element_rect(fill = "white", colour = NA),
    strip.background = element_rect(fill = "white"),
    plot.background = element_rect(colour = "white", fill = "white", size = 1), 
    panel.grid = element_line(color = "black", size = 0.05), 
    axis.title.y = element_blank(), 
    axis.title.x = element_blank()) +
  labs(title = "The number of daily Divvy trips fluctuate with the changing seasons",
    subtitle = "Daily Divvy trip count in the City of Chicago \nfrom June 2016 - June 2017",
    caption = "Source: Chicago Data Portal",
    fill = "Seasons")

```

###Plot 2: Usage fluctuations by weekday

The Southwest and West side show inverse patterns.
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=6, fig.width=9}
divvy_comp %>%
  filter(year(START.TIME) == c(2017)) %>%
  filter(!is.na(Community.Areas)) %>%
  mutate(WEEK.DAY = wday(START.TIME, label = TRUE),
         year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME)) %>%
  group_by(year, month, day, Chicago.side, WEEK.DAY, Chicago.side) %>%
  count() %>%
#  rename("TRIP.NUM" = "freq") %>%
  group_by(WEEK.DAY, Chicago.side) %>%
  dplyr::summarise(MEAN.TRIP.NUM = mean(n)) %>%
  ggplot(aes(x = WEEK.DAY, y = MEAN.TRIP.NUM, fill = WEEK.DAY)) +
  geom_col() +
  facet_wrap(~ Chicago.side) +
  coord_flip() +
  scale_fill_bikeshare(palette = "main") +
  bikeshare_style() +
  labs(title = "The South Side maintains high average Divvy bike usage throughout the week",
    subtitle = "Average Divvy bike usage in 2017",
    caption = "Source: Chicago Data Portal",
    x = "Chicago Sides'",
    y = "Daily bike ride average") +
  scale_y_continuous(expand=c(0,0)) +
  scale_x_discrete(expand=c(0,0)) +
  theme(legend.position="none", 
        strip.text.x = element_text(size = 10), 
        panel.margin = unit(1, "lines"),
        axis.title.y = element_blank())
```

###Plot 3: Median Divvy Bike ride time per Community Area (above and below global median)
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=6, fig.width=9}
# Global median time for trip duration in the city of chicago
# Median trip duration in Chicago is 11.46667	minutes
#divvy_comp %>%
#  filter(!is.na(Community.Areas)) %>%
#  filter(year(START.TIME) == c(2017)) %>%
#  filter(!TRIP.DURATION > 86400) %>% # Filter out bikes classified as stolen (greater than 24 hours)
#  summarise(median_trip_duration = median(TRIP.DURATION)/60)

divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  filter(year(START.TIME) == c(2017)) %>%
  filter(!TRIP.DURATION > 86400) %>% # Filter out bikes classified as stolen (greater than 24 hours)
  group_by(Community.Area.Name, Chicago.side) %>%
  dplyr::summarise(median_time = median(TRIP.DURATION)/60) %>% # average trip by comm area in Minutes
  mutate(de_meaned_time = median_time - 11.46) %>%
  mutate(axis_color = ifelse(de_meaned_time > 0, "red", "blue")) %>%
  ggplot(aes()) +
  geom_segment(aes(x = reorder(as.factor(Community.Area.Name), de_meaned_time), xend = Community.Area.Name, y = 0, yend = de_meaned_time, color = axis_color), size=1.3, alpha=0.9) +
  theme(
    legend.position = "none"
  ) +
  xlab("") +
  coord_flip() +
  bikeshare_style() +
  scale_y_continuous(expand=c(0,0), breaks = c(-4, -2, 0, 2, 4, 6, 8, 10, 12)) +
#  scale_y_continuous(expand=c(0,0)) +
  scale_x_discrete(expand=c(0,0)) +
  labs(title = "Median Divvy bike rental time is 2 - 10 minutes higher than the \nCity wide median in many suburban areas",
    subtitle = "The median Divvy bike rental time Chicago-wide in 2017 was 11.5 minutes",
    caption = "Source: Chicago Data Portal",
    x = "Chicago Community Areas", 
    y = "Minutes above and below Chicago's Median Divvy Rental Time", 
    fill = "Divvy Plan Types")
```

###Plot 4: Divvy Bike Customer type by Chicago Side (percentages)
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=6, fig.width=9}
#table(divvy_comp$USER.TYPE, divvy_comp$Chicago.side)

#divvy_comp$USER.TYPE <- fct_recode(divvy_comp$USER.TYPE, "Customer" = "Single Riders", "Subscriber" = #"Annual Member", "Dependent" = "24Hrs Unlimited Rides")

divvy_comp %>%
  filter(!USER.TYPE == "Dependent") %>%
  mutate(USER.TYPE = fct_recode(USER.TYPE, "Single Riders" = "Customer")) %>%
  mutate(USER.TYPE = fct_recode(USER.TYPE, "Annual Member" = "Subscriber")) %>%
  group_by(USER.TYPE) %>%
  ggplot(aes(x = Chicago.side, fill = USER.TYPE)) +
  geom_bar(position = "fill") +
  coord_flip() +
  ylab("proportion") +
  bikeshare_style() +
  labs(title = "Divvy Bike 'Single-ride' usage rate is highest on the South Side",
    subtitle = "Divvy bike customers can choose between three different plans: Single Ride, Explorer Pass and \nAnnual Membership. The proportion of Explorer Pass customers is negligible and has been omitted.",
    caption = "Source: Chicago Data Portal",
    y = "% Customer Type by Chicago Side", 
    fill = "Divvy Plan Types") +
  scale_y_continuous(expand=c(0,0), 
                     labels=c("0.00" = "0", "0.25" = "25", 
                                             "0.50" = "50", "0.75" = "75", "1.00" = "100")) +
  scale_x_discrete(expand=c(0,0)) +
  scale_fill_bikeshare(palette = "two_variables") +
  theme(axis.title.y = element_blank())
```

###Plot 5: Proportion of population vs. proportion of trips originating in the area
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=6, fig.width=9}
#Proportion of rides per chicago side
divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  filter(year(START.TIME) == c(2017)) %>%
  group_by(Community.Areas) %>%
  dplyr::summarise(pop = unique(Total.Population), 
            n_rides = n()) %>%
  left_join(chi_ca, by = "Community.Areas") %>%
  group_by(Chicago.side) %>%
  dplyr::summarise(sum_pop = sum(pop), 
            sum_rides = sum(n_rides)) %>%
  gather(key = object, value = value, c(sum_pop, sum_rides)) %>%
  ggplot(aes(x = object, y = value, fill = Chicago.side)) +
  geom_col(position = "fill") +
  ggtitle("Proportion of population vs. proportion of trips originating in the area") +
  scale_fill_bikeshare() +
  bikeshare_style() +
  labs(title = "The percentage of Divvy bike trips that originate on the South Side far outstrips \nthe areas percentage of Chicago's population",
    subtitle = "2017 Divvy Ridership Data",
 #   y = "Customer Type Proportions by Chicago Side", 
    fill = "Chicago Sides'", 
 caption = "Source: Chicago Data Portal") +
  scale_y_continuous(expand=c(0,0), labels=c("0.00" = "0", "0.25" = "25", 
                                             "0.50" = "50", "0.75" = "75", "1.00" = "100")) +
  scale_x_discrete(expand=c(0,0), labels=c("sum_pop" = "% of population by Chicago Side", "sum_rides" = "% of Divvy bike rides by Chicago Side")) +
  scale_fill_bikeshare(palette = "main") +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.title.y=element_blank())
```

###Plot 6: Average distance of divvy trip by Chicago Side 
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=6, fig.width=9}
divvy_comp %>%
  filter(!is.na(distance_meters)) %>%
  mutate(year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME), 
         date = as.Date(paste(year, month, day, sep='-')), 
         YEAR.MONTH = factor(paste(year, month, sep='-'))) %>%
  filter(year == 2018) %>%
  group_by(Chicago.side) %>%
  dplyr::summarise(avg_distance_meters = mean(distance_meters)) %>%
  ggplot(aes(x = reorder(Chicago.side, avg_distance_meters), y = avg_distance_meters, 
             color = Chicago.side), fill = "#2c7bb6") +
  geom_point() +
  theme(legend.position = "none") +
  labs(title = "The South Side accounts for the shortest average Divvy \ntrips by distance within the City of Chicago",
    subtitle = "Average distance traveled by Divvy bikes per Chicago Side in 2018",
    caption = "Chicago Data Portal Divvy Trip Data",
    x = "Chicago 'Sides'",
    y = "Average Divvy Trip Distance (Meters)") +
  coord_flip() +
   bikeshare_style() +
  scale_color_bikeshare(palette = "main")
```

###Plot 7: Average Ride time reduces as number of stations increase

This graph compares Divvy ride time changes between 2014 and 2017. This shows a strong linkage between number of divvy bike stations in an area and trip duration. All areas show a clear decline in the average trip duration as the number of stations increase. 
```{r warning=FALSE, message=FALSE, error=FALSE, fig.height=6, fig.width=9}
divvy_stations_year <- 
  divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  mutate(year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME), 
         date = as.Date(paste(year, month, day, sep='-')), 
         YEAR.MONTH = factor(paste(year, month, sep='-'))) %>%
  group_by(Chicago.side, year) %>%
  distinct(FROM.STATION.ID) %>%
  summarise(n_stations = n()) 

divvy_comp %>%
  filter(!is.na(Community.Areas)) %>%
  mutate(year = year(START.TIME), 
         month = month(START.TIME), 
         day = day(START.TIME), 
         date = as.Date(paste(year, month, day, sep='-')), 
         YEAR.MONTH = factor(paste(year, month, sep='-'))) %>%
  filter(year == c(2015, 2017)) %>%
  group_by(Chicago.side, year) %>%
  summarise(average_trip_time = mean(TRIP.DURATION)) %>%
  left_join(divvy_stations_year, by = c("Chicago.side", "year")) %>%
  arrange(Chicago.side, year) %>%
  ggplot(aes(x = year, y = average_trip_time, 
             group = Chicago.side, 
             size = n_stations, 
             color = as.factor(Chicago.side))) +
  geom_point(size = 2) +
  geom_line(size = 1) +
  labs(title = "Average ride time reduces as number of stations increase",
    subtitle = "Average trip time comparison across all 'Chicago Sides' in 2015 and 2017",
    caption="Chicago Data Portal Divvy Trip Data",
    x="Year",
    y="Divvy Trip Time (In Seconds)",
    color = "Chicago 'Side'",
    size = "Number of Stations") +
  theme_bw() +
#  theme(legend.position = "none") +
  theme(panel.border = element_blank()) +
  scale_x_discrete(position = "bottom", breaks = c("2015", "2017")) +
  scale_color_bikeshare(palette = "main")
#  scale_x_discrete(breaks = c(2014, 2017))
```


